<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>datEAUbase ERD</title>
    
    <!-- JointJS and dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.1/backbone-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.1/joint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/graphlib/2.1.8/graphlib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Styling -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.1/joint.min.css" />

    <style>
        :root {
            --bg-color: #f0f2f5;
            --table-bg: #ffffff;
            --table-border: #e2e8f0;
            --header-bg: #f8fafc;
            --header-text: #1e293b;
            --text-primary: #334155;
            --text-secondary: #64748b;
            --accent-color: #3b82f6;
            --pk-color: #eab308;
            --fk-color: #8b5cf6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        #paper {
            flex-grow: 1;
            overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- Custom HTML Element Styles --- */
        .html-element {
            position: absolute;
            background: var(--table-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--table-border);
            pointer-events: auto; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: box-shadow 0.2s ease; /* transition removed for transform to avoid lag during drag */
            transform-origin: 0 0;
            z-index: 100 !important; /* Ensure it floats above SVG */
        }

        /* Add cursor styles */
        .table-header {
            cursor: move; /* Indicate draggable */
        }
        .info-btn {
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .info-btn:hover {
            background-color: #e2e8f0;
        }
        .html-element.selected {
            box-shadow: 0 0 0 2px var(--accent-color), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100 !important;
        }

        .table-header {
            background: var(--header-bg);
            padding: 8px 12px;
            border-bottom: 1px solid var(--table-border);
            font-weight: 600;
            font-size: 14px;
            color: var(--header-text);
            display: flex;
            align-items: center;
            justify-content: space-between;
            pointer-events: auto; /* Allow dragging from header */
        }

        .table-body {
            pointer-events: auto;
        }

        .table-row {
            display: flex;
            padding: 6px 12px;
            font-size: 12px;
            border-bottom: 1px solid #f1f5f9;
            align-items: center;
            cursor: pointer;
            transition: background 0.1s;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        /* --- View-specific styles --- */
        .html-element.view {
            border: 2px dashed #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }

        .html-element.view .table-header {
            background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
            color: #1e40af;
        }

        .view-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: 500;
        }

        .table-row:hover {
            background: #f8fafc;
        }

        .col-key {
            width: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            margin-right: 8px;
        }

        .col-name {
            flex-grow: 1;
            font-weight: 500;
            color: var(--text-primary);
            margin-right: 12px;
        }

        .col-type {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-secondary);
            font-size: 11px;
        }

        .pk-badge { color: var(--pk-color); }
        .fk-badge { color: var(--fk-color); }

        /* --- Sidebar Styles --- */
        #sidebar {
            width: 300px;
            background: white;
            border-left: 1px solid var(--table-border);
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            box-shadow: -4px 0 15px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        #sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--table-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-secondary);
        }

        .sidebar-content {
            padding: 16px;
            overflow-y: auto;
        }

        .field-detail {
            margin-bottom: 16px;
        }

        .detail-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.5;
        }
        
        .type-tag {
            display: inline-block;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        /* --- Toolbar --- */
        .toolbar {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            gap: 8px;
            z-index: 999;
        }

        .tool-btn {
            padding: 8px 12px;
            background: var(--header-bg);
            border: 1px solid var(--table-border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #e2e8f0;
        }

        .tool-btn.primary {
            background: var(--accent-color);
            color: white;
            border: none;
        }
        
        .tool-btn.primary:hover {
            background: #2563eb;
        }

    </style>
</head>
<body>

    <div class="toolbar">
        <button class="tool-btn primary" onclick="autoLayout()">Running Auto Layout...</button>
        <button class="tool-btn" onclick="zoomIn()">+</button>
        <button class="tool-btn" onclick="zoomOut()">-</button>
        <button class="tool-btn" onclick="exportPNG()">Save as PNG</button>
        <button class="tool-btn" onclick="exportSVG()">Save as SVG</button>
    </div>

    <div id="paper"></div>

    <div id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Field Details</span>
            <button class="close-btn" onclick="closeSidebar()">Ã—</button>
        </div>
        <div class="sidebar-content" id="sidebar-details">
            <div class="detail-value" style="color: var(--text-secondary); font-style: italic;">
                Select a field to view details.
            </div>
        </div>
    </div>

    <script>
        const erdData = {
  "tables": [
    {
      "id": "Comments",
      "label": "Comments",
      "description": "Stores any additional textual comments, notes, or observations related to a specific measured value",
      "fields": [
        {
          "name": "Comment_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Comment",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Comment on the data in the Value table"
        }
      ]
    },
    {
      "id": "Contact",
      "label": "Contact",
      "description": "Stores detailed personal and professional information for people involved in projects (e.g., name, affiliation, function, e-mail, phone)",
      "fields": [
        {
          "name": "Contact_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Contact table"
        },
        {
          "name": "Last_name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Last name of the contact"
        },
        {
          "name": "First_name",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "First name of the contact"
        },
        {
          "name": "Company",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Company name"
        },
        {
          "name": "Status",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Status of the person. For example: \"Master student\", \"Postdoc\" or \"Intern\""
        },
        {
          "name": "Function",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "More detailed description about the functions"
        },
        {
          "name": "Office_number",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Number of the office"
        },
        {
          "name": "Email",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "E-mail address"
        },
        {
          "name": "Phone",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Phone number"
        },
        {
          "name": "Skype_name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Skype name"
        },
        {
          "name": "Linkedin",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "LinkedIn account"
        },
        {
          "name": "Street_number",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: number of the street"
        },
        {
          "name": "Street_name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the street"
        },
        {
          "name": "City",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the city"
        },
        {
          "name": "Zip_code",
          "sql_type": "NVARCHAR(45)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: zip code"
        },
        {
          "name": "Country",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the country"
        },
        {
          "name": "Website",
          "sql_type": "NVARCHAR(60)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Website URL of the contact or organization"
        }
      ]
    },
    {
      "id": "Equipment",
      "label": "Equipment",
      "description": "Stores information about a specific, physical piece of equipment (e.g., serial number, owner, purchase date, storage location)",
      "fields": [
        {
          "name": "Equipment_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Equipment table"
        },
        {
          "name": "model_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "equipment_model.Equipment_model_ID",
          "description": "Link to the Equipment model table"
        },
        {
          "name": "identifier",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Identification name of the equipments"
        },
        {
          "name": "Serial_number",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Serial number of the equipment"
        },
        {
          "name": "Owner",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the owner of the equipment"
        },
        {
          "name": "Storage_location",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Where is the procedure stored"
        },
        {
          "name": "Purchase_date",
          "sql_type": "DATE",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Date when the equipment was bought: 'YYYY-MM-DD"
        }
      ]
    },
    {
      "id": "EquipmentModel",
      "label": "EquipmentModel",
      "description": "Stores detailed, non-redundant specifications for a specific sensor or instrument model (e.g., manufacturer, functions, method)",
      "fields": [
        {
          "name": "Equipment_model_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Equipment model table"
        },
        {
          "name": "Equipment_model",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the equipment model. For example: ammo::lyser"
        },
        {
          "name": "Method",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Method behind the equipment"
        },
        {
          "name": "Functions",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the functions of the equipment"
        },
        {
          "name": "Manufacturer",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the manufacturer"
        },
        {
          "name": "Manual_location",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Location where the manual is stored"
        }
      ]
    },
    {
      "id": "EquipmentModelHasParameter",
      "label": "EquipmentModelHasParameter",
      "description": "Links equipment models to the parameters they can measure",
      "fields": [
        {
          "name": "Equipment_model_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "equipment_model.Equipment_model_ID",
          "description": "Link to the Equipment model table"
        },
        {
          "name": "Parameter_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "parameter.Parameter_ID",
          "description": "Link to the Parameter table"
        }
      ]
    },
    {
      "id": "EquipmentModelHasProcedures",
      "label": "EquipmentModelHasProcedures",
      "description": "Links equipment models to the relevant maintenance procedures",
      "fields": [
        {
          "name": "Equipment_model_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "equipment_model.Equipment_model_ID",
          "description": "Link to the Equipment model table"
        },
        {
          "name": "Procedure_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "procedure.Procedure_ID",
          "description": "Link to the Procedures table"
        }
      ]
    },
    {
      "id": "HydrologicalCharacteristics",
      "label": "HydrologicalCharacteristics",
      "description": "Stores the hydrological land use percentages (e.g., forest, wetlands, cropland, grassland) within the watershed",
      "fields": [
        {
          "name": "Watershed_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Linked to the Watershed table"
        },
        {
          "name": "Urban_area",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of urban areas"
        },
        {
          "name": "Forest",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of forest areas"
        },
        {
          "name": "Wetlands",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of wetlands"
        },
        {
          "name": "Cropland",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of croplands"
        },
        {
          "name": "Meadow",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of meadow areas"
        },
        {
          "name": "Grassland",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of grasslands"
        }
      ]
    },
    {
      "id": "MetaData",
      "label": "MetaData",
      "description": "Central context aggregator linking every measurement to its full provenance (project, contact, equipment, parameter, procedure, unit, purpose, sampling point, and condition)",
      "fields": [
        {
          "name": "Metadata_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Surrogate primary key"
        },
        {
          "name": "Project_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "project.Project_ID",
          "description": "Links to the research or monitoring project"
        },
        {
          "name": "Contact_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "contact.Contact_ID",
          "description": "Links to the person responsible for this measurement series"
        },
        {
          "name": "Equipment_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "equipment.Equipment_ID",
          "description": "Links to the physical instrument that produced the measurements"
        },
        {
          "name": "Parameter_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "parameter.Parameter_ID",
          "description": "Links to the measured analyte or parameter (e.g. TSS, pH)"
        },
        {
          "name": "Procedure_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "procedure.Procedure_ID",
          "description": "Links to the standard operating procedure used"
        },
        {
          "name": "Unit_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "unit.Unit_ID",
          "description": "Links to the measurement unit (e.g. mg/L)"
        },
        {
          "name": "Purpose_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "purpose.Purpose_ID",
          "description": "Links to the measurement purpose (online, lab, calibration, validation)"
        },
        {
          "name": "Sampling_point_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "sampling_point.Sampling_point_ID",
          "description": "Links to the physical sampling location"
        },
        {
          "name": "Condition_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "condition.Condition_ID",
          "description": "Links to the prevailing weather condition at time of measurement"
        }
      ]
    },
    {
      "id": "Parameter",
      "label": "Parameter",
      "description": "Stores the different water quality or quantity parameters that are measured (e.g., pH, TSS, N-components)",
      "fields": [
        {
          "name": "Unit_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "unit.Unit_ID",
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Parameter",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the parameter"
        },
        {
          "name": "Parameter_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Parameter table"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the parameter"
        }
      ]
    },
    {
      "id": "ParameterHasProcedures",
      "label": "ParameterHasProcedures",
      "description": "Links parameters to the relevant measurement procedures",
      "fields": [
        {
          "name": "Procedure_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "procedure.Procedure_ID",
          "description": "Link to the Procedures table"
        },
        {
          "name": "Parameter_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "parameter.Parameter_ID",
          "description": "Link to the Parameter table"
        }
      ]
    },
    {
      "id": "Procedures",
      "label": "Procedures",
      "description": "Stores details for different measurement procedures (e.g., calibration, validation, standard operating procedures, ISO methods)",
      "fields": [
        {
          "name": "Procedure_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Procedures table"
        },
        {
          "name": "Procedure_name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Title name of the procedure"
        },
        {
          "name": "Procedure_type",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Type of the procedure. For example, SOP"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the procedure"
        },
        {
          "name": "Procedure_location",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Where is the procedure stored"
        }
      ]
    },
    {
      "id": "Project",
      "label": "Project",
      "description": "Stores descriptive information about the research or monitoring project for which the data was collected",
      "fields": [
        {
          "name": "Project_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Project table"
        },
        {
          "name": "name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the project"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the project"
        }
      ]
    },
    {
      "id": "ProjectHasContact",
      "label": "ProjectHasContact",
      "description": "Links projects to the personnel involved in them",
      "fields": [
        {
          "name": "Contact_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "contact.Contact_ID",
          "description": "Link to the Contact table"
        },
        {
          "name": "Project_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "project.Project_ID",
          "description": "Link to the Project table"
        }
      ]
    },
    {
      "id": "ProjectHasEquipment",
      "label": "ProjectHasEquipment",
      "description": "Links projects to the specific equipment used within them",
      "fields": [
        {
          "name": "Equipment_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "equipment.Equipment_ID",
          "description": "Link to the Equipment table"
        },
        {
          "name": "Project_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "project.Project_ID",
          "description": "Link to the Project table"
        }
      ]
    },
    {
      "id": "ProjectHasSamplingPoints",
      "label": "ProjectHasSamplingPoints",
      "description": "Links projects to the sampling points used within them",
      "fields": [
        {
          "name": "Project_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "project.Project_ID",
          "description": "Link to the Project table"
        },
        {
          "name": "Sampling_point_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": true,
          "is_required": true,
          "fk_target": "sampling_point.Sampling_point_ID",
          "description": "Link to the Sampling_point table"
        }
      ]
    },
    {
      "id": "Purpose",
      "label": "Purpose",
      "description": "Stores information about the aim of the measurement (e.g., on-line measurement, laboratory analysis, calibration, validation, cleaning)",
      "fields": [
        {
          "name": "Purpose_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Purpose",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Purpose of the data collection. For example, \"Measurement\", \"Lab_analysis\", \"Calibration\" and \"Cleaning\""
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the purpose"
        }
      ]
    },
    {
      "id": "SamplingPoints",
      "label": "SamplingPoints",
      "description": "Stores the identification, specific geographical coordinates (Latitude/Longitude/GPS), and description of a particular spot where a sample or measurement is taken",
      "fields": [
        {
          "name": "Sampling_point_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Link to the Sampling_point table"
        },
        {
          "name": "Site_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "site.Site_ID",
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Sampling_point",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Where the sample was taken. For example: \"Inlet\", \"Outlet\" or \"Upstream\""
        },
        {
          "name": "Sampling_location",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Where the sample was taken. For example: \"Biofiltration\", \"Sewer 01\" or \"Retention Tank\""
        },
        {
          "name": "Latitude_GPS",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "GPS coordinates. For example: 47\u00b054\u203225.103\" "
        },
        {
          "name": "Longitude_GPS",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "GPS coordinates. For example: $73^{\\circ}47^{\\prime}00.024^{\\prime\\prime}$"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the sampling point"
        },
        {
          "name": "Pictures",
          "sql_type": "/* UNMAPPED TYPE */",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Picture of the site"
        }
      ]
    },
    {
      "id": "SchemaVersion",
      "label": "SchemaVersion",
      "description": "Tracks which schema versions have been applied to this database instance",
      "fields": [
        {
          "name": "VersionID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Surrogate primary key"
        },
        {
          "name": "Version",
          "sql_type": "NVARCHAR(20)",
          "is_pk": false,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Schema version string (e.g. 1.0.1)"
        },
        {
          "name": "AppliedAt",
          "sql_type": "DATETIME2(7)",
          "is_pk": false,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Datetime when this migration was applied"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(500)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Human-readable description of what this migration does"
        },
        {
          "name": "MigrationScript",
          "sql_type": "NVARCHAR(200)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Filename of the migration script that was applied"
        }
      ]
    },
    {
      "id": "Site",
      "label": "Site",
      "description": "Stores general site information, including address, site type, and a link to the associated watershed",
      "fields": [
        {
          "name": "Site_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Watershed_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "watershed.Watershed_ID",
          "description": "Linked to the Watershed table"
        },
        {
          "name": "name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the site"
        },
        {
          "name": "type",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "For example: \"WWTP\", \"River\" or \"Sewer_system\""
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the site"
        },
        {
          "name": "Picture",
          "sql_type": "/* UNMAPPED TYPE */",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Picture of the site"
        },
        {
          "name": "Street_number",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: number of the street"
        },
        {
          "name": "Street_name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the street"
        },
        {
          "name": "City",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the city"
        },
        {
          "name": "Zip_code",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: zip code"
        },
        {
          "name": "Province",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the province"
        },
        {
          "name": "Country",
          "sql_type": "NVARCHAR(255)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Address: name of the country"
        }
      ]
    },
    {
      "id": "Unit",
      "label": "Unit",
      "description": "Stores the SI units of measurement (or other relevant units) corresponding to the parameters (e.g., mg/L, g/L, s)",
      "fields": [
        {
          "name": "Unit_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Unit",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "SI-units only"
        }
      ]
    },
    {
      "id": "UrbanCharacteristics",
      "label": "UrbanCharacteristics",
      "description": "Stores the urban land use percentages (e.g., commercial, residential, green spaces) within the watershed",
      "fields": [
        {
          "name": "Watershed_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Linked to the Watershed table"
        },
        {
          "name": "Commercial",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of commercial areas. For example stores or bank areas"
        },
        {
          "name": "Green_spaces",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of green spaces"
        },
        {
          "name": "Industrial",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of industrial areas. For example factories"
        },
        {
          "name": "Institutional",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of institutional areas. For example schools, police stations or city hall"
        },
        {
          "name": "Residential",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of residential areas. For example houses or apartment buildings"
        },
        {
          "name": "Agricultural",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of agricultural land use. For example farm land"
        },
        {
          "name": "Recreational",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage [%] of recreational areas. For example parks or sport fields"
        }
      ]
    },
    {
      "id": "Value",
      "label": "Value",
      "description": "Stores each measured water quality or quantity value, its time stamp, replicate identification, and the link to its specific metadata set",
      "fields": [
        {
          "name": "Comment_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "comment.Comment_ID",
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Metadata_ID",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": true,
          "is_required": false,
          "fk_target": "metadata.Metadata_ID",
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Value_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Value",
          "sql_type": "FLOAT",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Value of collected data"
        },
        {
          "name": "Number_of_experiment",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Number of replica of an experiment"
        },
        {
          "name": "Timestamp",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Unix timestamp combining date and time of collected data"
        }
      ]
    },
    {
      "id": "Watershed",
      "label": "Watershed",
      "description": "Stores general information about the watershed area, including surface area, concentration time, and impervious surface percentage",
      "fields": [
        {
          "name": "Watershed_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "Linked to the Watershed table"
        },
        {
          "name": "name",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Name of the watershed"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the watershed"
        },
        {
          "name": "Surface_area",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Surface area of the watershed [ha]"
        },
        {
          "name": "Concentration_time",
          "sql_type": "INT",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Concentration time in minutes [min]"
        },
        {
          "name": "Impervious_surface",
          "sql_type": "REAL",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Percentage of the impervious surface of the watershed in percentage [%]"
        }
      ]
    },
    {
      "id": "WeatherCondition",
      "label": "WeatherCondition",
      "description": "Stores descriptive information about the prevailing weather conditions when the measurement was taken (e.g., dry weather, wet weather, snow melt)",
      "fields": [
        {
          "name": "Condition_ID",
          "sql_type": "INT",
          "is_pk": true,
          "is_fk": false,
          "is_required": true,
          "fk_target": null,
          "description": "A unique ID is generated automatically by MySQL"
        },
        {
          "name": "Weather_condition",
          "sql_type": "NVARCHAR(100)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Type of weather condition"
        },
        {
          "name": "Description",
          "sql_type": "NVARCHAR(MAX)",
          "is_pk": false,
          "is_fk": false,
          "is_required": false,
          "fk_target": null,
          "description": "Description of the condition"
        }
      ]
    }
  ],
  "views": [],
  "relationships": [
    {
      "from_table": "Equipment",
      "to_table": "EquipmentModelHasProcedures",
      "from_field": "model_ID",
      "to_field": "Equipment_model_ID",
      "relationship_type": null
    },
    {
      "from_table": "EquipmentModelHasParameter",
      "to_table": "EquipmentModelHasProcedures",
      "from_field": "Equipment_model_ID",
      "to_field": "Equipment_model_ID",
      "relationship_type": null
    },
    {
      "from_table": "EquipmentModelHasParameter",
      "to_table": "ParameterHasProcedures",
      "from_field": "Parameter_ID",
      "to_field": "Parameter_ID",
      "relationship_type": null
    },
    {
      "from_table": "EquipmentModelHasProcedures",
      "to_table": "EquipmentModelHasProcedures",
      "from_field": "Equipment_model_ID",
      "to_field": "Equipment_model_ID",
      "relationship_type": null
    },
    {
      "from_table": "EquipmentModelHasProcedures",
      "to_table": "Procedures",
      "from_field": "Procedure_ID",
      "to_field": "Procedure_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "ProjectHasSamplingPoints",
      "from_field": "Project_ID",
      "to_field": "Project_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "ProjectHasContact",
      "from_field": "Contact_ID",
      "to_field": "Contact_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "ProjectHasEquipment",
      "from_field": "Equipment_ID",
      "to_field": "Equipment_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "ParameterHasProcedures",
      "from_field": "Parameter_ID",
      "to_field": "Parameter_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "Procedures",
      "from_field": "Procedure_ID",
      "to_field": "Procedure_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "Unit",
      "from_field": "Unit_ID",
      "to_field": "Unit_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "Purpose",
      "from_field": "Purpose_ID",
      "to_field": "Purpose_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "SamplingPoints",
      "from_field": "Sampling_point_ID",
      "to_field": "Sampling_point_ID",
      "relationship_type": null
    },
    {
      "from_table": "MetaData",
      "to_table": "WeatherCondition",
      "from_field": "Condition_ID",
      "to_field": "Condition_ID",
      "relationship_type": null
    },
    {
      "from_table": "Parameter",
      "to_table": "Unit",
      "from_field": "Unit_ID",
      "to_field": "Unit_ID",
      "relationship_type": null
    },
    {
      "from_table": "ParameterHasProcedures",
      "to_table": "Procedures",
      "from_field": "Procedure_ID",
      "to_field": "Procedure_ID",
      "relationship_type": null
    },
    {
      "from_table": "ParameterHasProcedures",
      "to_table": "ParameterHasProcedures",
      "from_field": "Parameter_ID",
      "to_field": "Parameter_ID",
      "relationship_type": null
    },
    {
      "from_table": "ProjectHasContact",
      "to_table": "ProjectHasContact",
      "from_field": "Contact_ID",
      "to_field": "Contact_ID",
      "relationship_type": null
    },
    {
      "from_table": "ProjectHasContact",
      "to_table": "ProjectHasSamplingPoints",
      "from_field": "Project_ID",
      "to_field": "Project_ID",
      "relationship_type": null
    },
    {
      "from_table": "ProjectHasEquipment",
      "to_table": "ProjectHasEquipment",
      "from_field": "Equipment_ID",
      "to_field": "Equipment_ID",
      "relationship_type": null
    },
    {
      "from_table": "ProjectHasEquipment",
      "to_table": "ProjectHasSamplingPoints",
      "from_field": "Project_ID",
      "to_field": "Project_ID",
      "relationship_type": null
    },
    {
      "from_table": "ProjectHasSamplingPoints",
      "to_table": "ProjectHasSamplingPoints",
      "from_field": "Project_ID",
      "to_field": "Project_ID",
      "relationship_type": null
    },
    {
      "from_table": "ProjectHasSamplingPoints",
      "to_table": "SamplingPoints",
      "from_field": "Sampling_point_ID",
      "to_field": "Sampling_point_ID",
      "relationship_type": null
    },
    {
      "from_table": "SamplingPoints",
      "to_table": "Site",
      "from_field": "Site_ID",
      "to_field": "Site_ID",
      "relationship_type": null
    },
    {
      "from_table": "Site",
      "to_table": "Watershed",
      "from_field": "Watershed_ID",
      "to_field": "Watershed_ID",
      "relationship_type": null
    },
    {
      "from_table": "Value",
      "to_table": "Comments",
      "from_field": "Comment_ID",
      "to_field": "Comment_ID",
      "relationship_type": null
    },
    {
      "from_table": "Value",
      "to_table": "MetaData",
      "from_field": "Metadata_ID",
      "to_field": "Metadata_ID",
      "relationship_type": null
    }
  ]
};

        // --- Custom HTML Element Definition ---
        joint.shapes.html = {};
        joint.shapes.html.Element = joint.shapes.standard.Rectangle.extend({
            defaults: joint.util.deepSupplement({
                type: 'html.Element',
                attrs: {
                    rect: { stroke: 'none', 'fill-opacity': 0 } // Invisible SVG rect
                }
            }, joint.shapes.standard.Rectangle.prototype.defaults)
        });

        joint.shapes.html.ElementView = joint.dia.ElementView.extend({
            htmlTemplate: null,

            initialize: function() {
                joint.dia.ElementView.prototype.initialize.apply(this, arguments);

                // Create the DIV that will mock the element
                this.div = document.createElement('div');
                this.div.className = 'html-element';
                this.div.id = this.model.id;

                // Check if this is a view
                if (this.model.get('isView')) {
                    this.div.classList.add('view');
                }

                // Prevent paper panning when clicking on the element
                this.div.addEventListener('mousedown', (e) => {
                    // We handle our own interactions
                    e.stopPropagation();

                    // Visual Selection
                    document.querySelectorAll('.html-element').forEach(el => el.classList.remove('selected'));
                    this.div.classList.add('selected');
                });

                this.renderContent();
                this.model.on('change', this.updateBox, this);
            },
            renderContent: function() {
                const isView = this.model.get('isView');
                const data = isView ? this.model.get('viewData') : this.model.get('tableData');

                // Escape string for usage in onclick
                const entityJson = JSON.stringify({
                    name: data.label,
                    description: data.description,
                    type: isView ? 'view' : 'table',
                    definition: data.view_definition || null
                }).replace(/"/g, '&quot;');

                let rowsHtml = '';
                const items = isView ? data.columns : data.fields;

                items.forEach(field => {
                    let keyBadge = '';
                    if (field.is_pk) keyBadge = '<span class="pk-badge" title="Primary Key">PK</span>';
                    else if (field.is_fk) keyBadge = '<span class="fk-badge" title="Foreign Key">FK</span>';

                    // Add asterisk for required fields
                    const requiredMarker = field.is_required ? '<span style="color: #ef4444;">*</span>' : '';

                    // Escape data for attribute usage
                    const fieldJson = JSON.stringify(field).replace(/"/g, '&quot;');

                    rowsHtml += `
                        <div class="table-row" onclick="showFieldDetails('${fieldJson}', '${data.label}', event)">
                            <div class="col-key">${keyBadge}</div>
                            <div class="col-name" title="${field.name}">${field.name}${requiredMarker}</div>
                            <div class="col-type" title="${field.sql_type}">${field.sql_type}</div>
                        </div>
                    `;
                });

                const badgeHtml = isView ? '<span class="view-badge">VIEW</span>' : '';

                this.div.innerHTML = `
                    <div class="table-header" onmousedown="startDrag(event, '${this.model.id}')">
                        <span>${data.label}</span>${badgeHtml}
                        <span class="info-btn" onclick="showTableDetails('${entityJson}', event)">â„¹ï¸</span>
                    </div>
                    <div class="table-body">
                        ${rowsHtml}
                    </div>
                `;
            },
            render: function() {
                joint.dia.ElementView.prototype.render.apply(this, arguments);
                
                // Add the DIV to the paper container
                // We use paper.el to ensure it's in the same container
                // Append ensures it is visually on top of the SVG if z-index is equal (but we forced z-index 100)
                this.paper.$el.append(this.div);
                
                this.updateBox();
                return this;
            },

            updateBox: function() {
                const bbox = this.model.getBBox();
                const scale = this.paper.scale();
                const tr = this.paper.translate();

                this.div.style.transform = `translate(${bbox.x * scale.sx + tr.tx}px, ${bbox.y * scale.sy + tr.ty}px) scale(${scale.sx})`;
                this.div.style.transformOrigin = '0 0';
                this.div.style.width = bbox.width + 'px';
                this.div.style.height = bbox.height + 'px';
                this.div.style.left = '0';
                this.div.style.top = '0';
            },

            remove: function() {
                // Clean up
                if (this.div) this.div.remove();
                joint.dia.ElementView.prototype.remove.apply(this, arguments);
            }
        });

        // --- Init Graph ---
        const graph = new joint.dia.Graph();
        const paper = new joint.dia.Paper({
            el: document.getElementById('paper'),
            model: graph,
            width: '100%',
            height: '100%',
            gridSize: 10,
            drawGrid: true,
            background: { color: '#f0f2f5' },
            interactive: { linkMove: false }, // Allow element move, deny link move
            defaultRouter: { name: 'manhattan' },
            defaultConnector: { name: 'rounded' }
        });

        // --- Build Graph ---
        const tableElements = {};

        // 1. Create Nodes
        erdData.tables.forEach(table => {
            // Dynamic Width Calculation
            // Estimate text width: Label vs (Fields Name + Type)
            let maxChars = table.label.length;
            table.fields.forEach(f => {
                // Name + Type + Spacing
                const lineLength = f.name.length + f.sql_type.length + 5;
                if (lineLength > maxChars) maxChars = lineLength;
            });
            
            // Approx 10px per char + liberal padding
            let calculatedWidth = (maxChars * 10) + 80;
            // Clamping - Minimum width based on style preference
            if (calculatedWidth < 280) calculatedWidth = 280;
            if (calculatedWidth > 700) calculatedWidth = 700;

            // Calculate approximate height
            const headerHeight = 40;
            const rowHeight = 30; 
            // Add extra buffer + border
            const height = headerHeight + (table.fields.length * rowHeight) + 10; 

            const element = new joint.shapes.html.Element({
                position: { x: 0, y: 0 }, // Will be set by Layout
                size: { width: calculatedWidth, height: height },
                tableData: table // Pass full data to view
            });

            element.addTo(graph);
            tableElements[table.id] = element;
        });

        // 1b. Create View Nodes (with distinct styling)
        const viewElements = {};
        erdData.views.forEach(view => {
            // Dynamic Width Calculation
            let maxChars = view.label.length;
            view.columns.forEach(col => {
                const lineLength = col.name.length + col.sql_type.length + 5;
                if (lineLength > maxChars) maxChars = lineLength;
            });

            let calculatedWidth = (maxChars * 10) + 80;
            if (calculatedWidth < 280) calculatedWidth = 280;
            if (calculatedWidth > 700) calculatedWidth = 700;

            const headerHeight = 40;
            const rowHeight = 30;
            const height = headerHeight + (view.columns.length * rowHeight) + 10;

            const viewElement = new joint.shapes.html.Element({
                position: { x: 0, y: 0 },
                size: { width: calculatedWidth, height: height },
                viewData: view,
                isView: true
            });

            viewElement.addTo(graph);
            viewElements[view.id] = viewElement;
        });

        // Helper function to determine cardinality markers
        function getCardinalityMarkers(relType) {
            // Returns { sourceMarker, targetMarker } based on relationship type
            // Convention: arrow points from child (FK holder) to parent (PK holder)

            // Crow's foot marker (many side) - three lines spreading out
            const crowsFoot = {
                type: 'path',
                d: 'M 0 -5 L 10 0 L 0 5 M 10 0 L 10 -5 M 10 0 L 10 5',
                fill: 'none'
            };

            // Single line marker (one side)
            const oneLine = {
                type: 'path',
                d: 'M 10 -5 L 10 5',
                fill: 'none'
            };

            if (relType === 'one-to-one') {
                // One-to-one: single line on both ends
                return {
                    sourceMarker: oneLine,  // Child end (one)
                    targetMarker: oneLine   // Parent end (one)
                };
            } else if (relType === 'one-to-many') {
                // One-to-many: crow's foot on child (source), single line on parent (target)
                return {
                    sourceMarker: crowsFoot,  // Child end (many)
                    targetMarker: oneLine     // Parent end (one)
                };
            } else if (relType === 'many-to-many') {
                // Many-to-many: crow's foot on both ends
                return {
                    sourceMarker: crowsFoot,  // Many end
                    targetMarker: crowsFoot   // Many end
                };
            }

            // Default to one-to-many
            return {
                sourceMarker: crowsFoot,
                targetMarker: oneLine
            };
        }

        // 2. Create Links
        erdData.relationships.forEach(rel => {
            const source = tableElements[rel.from_table];
            const target = tableElements[rel.to_table];

            if (source && target) {
                const markers = getCardinalityMarkers(rel.relationship_type);

                const link = new joint.shapes.standard.Link({
                    source: { id: source.id },
                    target: { id: target.id },
                    relationshipData: rel, // Store data for click handler
                    attrs: {
                        line: {
                            stroke: '#94a3b8',
                            strokeWidth: 2,
                            sourceMarker: markers.sourceMarker,
                            targetMarker: markers.targetMarker
                        }
                    },
                    connector: { name: 'rounded' },
                    router: {
                        name: 'manhattan',
                        args: {
                            padding: 20,
                            step: 20,
                            startDirections: ['right'],
                            endDirections: ['left']
                        }
                    }
                });
                link.addTo(graph);
            }
        });

        // --- Auto Layout ---
        function autoLayout() {
            joint.layout.DirectedGraph.layout(graph, {
                dagre: dagre,
                graphlib: dagre.graphlib,
                rankDir: 'LR', // Left to Right flow is often better for wide tables
                nodeSep: 60,
                rankSep: 120,
                marginX: 50,
                marginY: 50
            });
            
            // Force update of HTML elements after layout moves SVG nodes
            graph.getElements().forEach(el => {
                // Trigger change event to update div position
                el.trigger('change:position'); 
            });
            
            paper.scaleContentToFit({ padding: 50, maxScale: 1 });
            // Update zoom level tracker
            currentScale = paper.scale().sx;
        }

        // Initial Layout
        setTimeout(autoLayout, 100);

        // --- Interaction ---
        
        // Zoom-Pan
        let currentScale = 1;
        const paperEl = document.getElementById('paper');
        
        // Pan logic
        let isPanning = false;
        let startPan = { x: 0, y: 0 };
        let initialPan = { x: 0, y: 0 };

        paper.on('blank:pointerdown', (evt, x, y) => {
            isPanning = true;
            startPan = { x: evt.clientX, y: evt.clientY };
            initialPan = paper.translate();
            paperEl.style.cursor = 'grabbing';
            closeSidebar(); // Also close sidebar on blank click
        });

        // Native Wheel Zoom (better for trackpads)
        paperEl.addEventListener('wheel', (evt) => {
            evt.preventDefault();
            
            // Normalize delta
            const delta = -Math.sign(evt.deltaY) * 0.1;
            const oldScale = currentScale;
            let newScale = oldScale + delta;
            
            // Clamp
            if (newScale < 0.2) newScale = 0.2;
            if (newScale > 3) newScale = 3;
            
            if (newScale !== oldScale) {
                currentScale = newScale;
                
                // Zoom towards mouse cursor
                // We need to calculate the new offset to keep the point under cursor stable
                // Current mouse position in DOM
                const rect = paperEl.getBoundingClientRect();
                const mouseX = evt.clientX - rect.left;
                const mouseY = evt.clientY - rect.top;
                
                // Convert mouse to graph coordinates (using OLD scale)
                const tr = paper.translate();
                const graphX = (mouseX - tr.tx) / oldScale;
                const graphY = (mouseY - tr.ty) / oldScale;
                
                // New Translate = Mouse - (Graph * NewScale)
                const newTx = mouseX - (graphX * newScale);
                const newTy = mouseY - (graphY * newScale);
                
                paper.scale(newScale, newScale);
                paper.translate(newTx, newTy);
                
                // Update HTML elements (scale event also handles this, but explicit check good)
            }
        }, { passive: false });
        
        // Custom Drag Logic for HTML Elements
        let isDraggingBox = false;
        let dragElementId = null;
        let dragStartOffset = { x: 0, y: 0 };
        
        function startDrag(evt, modelId) {
            // evt.preventDefault(); // allow text selection? No, header.
            isDraggingBox = true;
            dragElementId = modelId;
            
            const tr = paper.translate();
            const sc = paper.scale().sx;
            const model = graph.getCell(modelId);
            const pos = model.position();
            
            // Calculate where we clicked relative to model pos
            // Mouse (client) -> Graph Coords
            // But easier: just track delta from mouse down.
            // Wait, we need to update MODEL position.
            
            // Mouse Client X/Y
            // We'll track MovementX/Y in mousemove? No, that's unreliable.
            // Let's track absolute start.
            
            // Store original model position
            dragStartOffset = {
                clickX: evt.clientX,
                clickY: evt.clientY,
                modelX: pos.x,
                modelY: pos.y
            };
            
            paperEl.style.cursor = 'move';
        }


        // Global Mouse Move (handles both pan and box drag)
        document.addEventListener('mousemove', (evt) => {
            if (isPanning) {
                const dx = evt.clientX - startPan.x;
                const dy = evt.clientY - startPan.y;
                paper.translate(initialPan.tx + dx, initialPan.ty + dy);
            }
            
            if (isDraggingBox && dragElementId) {
                const dx = evt.clientX - dragStartOffset.clickX;
                const dy = evt.clientY - dragStartOffset.clickY;
                
                // Convert screen delta to graph delta
                // deltaGraph = deltaScreen / scale
                const sc = paper.scale().sx;
                const dGraphX = dx / sc;
                const dGraphY = dy / sc;
                
                const model = graph.getCell(dragElementId);
                model.position(dragStartOffset.modelX + dGraphX, dragStartOffset.modelY + dGraphY);
                
                // Links update automatically because model updates
            }
        });
        
        document.addEventListener('mouseup', () => {
            isPanning = false;
            isDraggingBox = false;
            dragElementId = null;
            paperEl.style.cursor = 'default';
        });
        
        // Link Click Handler
        paper.on('link:pointerdown', (linkView) => {
            const rel = linkView.model.get('relationshipData');
            if (!rel) return; // Guard against regular links if any
            
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('sidebar-details');
            
            content.innerHTML = `
                <div class="field-detail">
                    <div class="detail-label">Relationship</div>
                    <div class="type-tag">Foreign Key</div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Foreign Table (Many)</div>
                    <div class="detail-value">
                        <strong>${rel.from_table}</strong>.${rel.from_field}
                    </div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Primary Table (One)</div>
                    <div class="detail-value">
                        <strong>${rel.to_table}</strong>.${rel.to_field}
                    </div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Relationship</div>
                    <div class="detail-value">${rel.relationship_type}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                        ${rel.relationship_type === 'one-to-many' ? 'Many foreign records point to one primary record' : 
                           rel.relationship_type === 'one-to-one' ? 'One foreign record points to one primary record' :
                           'Many foreign records point to many primary records (via junction table)'}
                    </div>
                </div>
            `;
            sidebar.classList.add('open');
            
            // Highlight Link
            graph.getLinks().forEach(l => {
                l.attr('line/stroke', '#94a3b8');
                l.attr('line/strokeWidth', 2);
            });
            
            linkView.model.attr('line/stroke', '#3b82f6');
            linkView.model.attr('line/strokeWidth', 4);
        });
        
        // Paper Transform Listener to sync HTML elements
        // This is crucial. When paper zooms or pans, we must update the CSS transform of a container 
        // OR update every single element. Updating every element is easier for this scale.
        paper.on('render:done translate resize scale', () => {
            // This global update is heavy but ensures sync
            const transform = paper.translate();
            const scale = paper.scale();

            // Iterate all views
            for (const key in paper._views) {
                const view = paper._views[key];
                if (view.updateBox) {
                    const modelBox = view.model.getBBox();
                    // Transform model coordinates to paper coordinates
                    // (x * scale) + tx
                    const tx = transform.tx;
                    const ty = transform.ty;
                    const sx = scale.sx;
                    const sy = scale.sy;
                    
                    // Apply transform directly to the div for scaling and positioning
                    view.div.style.transform = `translate(${modelBox.x * sx + tx}px, ${modelBox.y * sy + ty}px) scale(${sx})`;
                    view.div.style.transformOrigin = '0 0'; // Scale from top-left
                    
                    // Set width/height based on original model size, let scale handle visual size
                    view.div.style.width = modelBox.width + 'px';
                    view.div.style.height = modelBox.height + 'px';
                }
            }
        });

        // --- Toolbar Functions ---
        function zoomIn() { currentScale += 0.1; paper.scale(currentScale); }
        function zoomOut() { currentScale -= 0.1; paper.scale(currentScale); }

        function exportPNG() {
            closeSidebar();

            // Get the paper element
            const paperElement = document.getElementById('paper');

            // Calculate the bounding box of all elements
            const bbox = graph.getBBox();

            // Add some padding
            const padding = 50;
            const width = bbox.width + (padding * 2);
            const height = bbox.height + (padding * 2);

            // Temporarily adjust view to fit content
            const originalTransform = paper.translate();
            const originalScale = paper.scale();

            // Reset to show all content
            paper.translate(padding - bbox.x, padding - bbox.y);
            paper.scale(1, 1);

            // Use html2canvas to render
            html2canvas(paperElement, {
                backgroundColor: '#f0f2f5',
                width: width,
                height: height,
                scrollX: 0,
                scrollY: 0,
                windowWidth: width,
                windowHeight: height,
                useCORS: true
            }).then(canvas => {
                // Convert canvas to blob and download
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = 'dateaubase_erd.png';
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });

                // Restore original view
                paper.translate(originalTransform.tx, originalTransform.ty);
                paper.scale(originalScale.sx, originalScale.sy);
            }).catch(err => {
                console.error('Error generating PNG:', err);
                alert('Error generating PNG. See console for details.');

                // Restore original view even on error
                paper.translate(originalTransform.tx, originalTransform.ty);
                paper.scale(originalScale.sx, originalScale.sy);
            });
        }

        function exportSVG() {
            closeSidebar();

            // Get the SVG element from the paper
            const svgElement = paper.svg;

            // Clone the SVG to avoid modifying the original
            const svgClone = svgElement.cloneNode(true);

            // Get bounding box for proper dimensions
            const bbox = graph.getBBox();
            const padding = 50;

            // Set viewBox and dimensions
            svgClone.setAttribute('viewBox', `${bbox.x - padding} ${bbox.y - padding} ${bbox.width + padding * 2} ${bbox.height + padding * 2}`);
            svgClone.setAttribute('width', bbox.width + padding * 2);
            svgClone.setAttribute('height', bbox.height + padding * 2);

            // Add background rectangle
            const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bgRect.setAttribute('x', bbox.x - padding);
            bgRect.setAttribute('y', bbox.y - padding);
            bgRect.setAttribute('width', bbox.width + padding * 2);
            bgRect.setAttribute('height', bbox.height + padding * 2);
            bgRect.setAttribute('fill', '#f0f2f5');
            svgClone.insertBefore(bgRect, svgClone.firstChild);

            // Embed HTML elements as foreignObject
            const htmlElements = document.querySelectorAll('.html-element');
            htmlElements.forEach(htmlEl => {
                const modelId = htmlEl.id;
                const model = graph.getCell(modelId);
                if (!model) return;

                const bbox = model.getBBox();

                // Create foreignObject to embed HTML
                const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                foreignObject.setAttribute('x', bbox.x);
                foreignObject.setAttribute('y', bbox.y);
                foreignObject.setAttribute('width', bbox.width);
                foreignObject.setAttribute('height', bbox.height);

                // Clone the HTML element and its styles
                const htmlClone = htmlEl.cloneNode(true);
                htmlClone.style.transform = 'none';
                htmlClone.style.position = 'relative';
                htmlClone.style.width = bbox.width + 'px';
                htmlClone.style.height = bbox.height + 'px';

                foreignObject.appendChild(htmlClone);
                svgClone.appendChild(foreignObject);
            });

            // Serialize SVG to string
            const serializer = new XMLSerializer();
            let svgString = serializer.serializeToString(svgClone);

            // Add XML declaration and namespaces
            svgString = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>' + svgString;

            // Create blob and download
            const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'dateaubase_erd.svg';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // --- Sidebar Logic ---
        function showFieldDetails(fieldJson, tableName, event) {
            event.stopPropagation(); // Prevent paper blank click from closing sidebar
            const field = JSON.parse(fieldJson);
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('sidebar-details');
            
            const desc = field.description || "No description available.";
            
            content.innerHTML = `
                <div class="field-detail">
                    <div class="detail-label">Table</div>
                    <div class="detail-value" style="font-weight: 600">${tableName}</div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Field</div>
                    <div class="detail-value">${field.name}</div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Type</div>
                    <div class="type-tag">${field.sql_type}</div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">${desc}</div>
                </div>
            `;
            
            if (field.is_fk && field.fk_target) {
                content.innerHTML += `
                     <div class="field-detail">
                        <div class="detail-label">Foreign Key Target</div>
                        <div class="detail-value">ðŸ”— ${field.fk_target}</div>
                    </div>
                `;
            }
            
            sidebar.classList.add('open');
            
            // Highlight row visually (already handled by onclick row class? No, need logic)
            // Remove previous highlights
            document.querySelectorAll('.table-row').forEach(r => r.style.background = '');
            // Highlight current
            event.currentTarget.style.background = '#e0e7ff';
        }
        
        function showTableDetails(tableJson, event) {
            event.stopPropagation();
            const entity = JSON.parse(tableJson);
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('sidebar-details');

            const typeLabel = entity.type === 'view' ? 'View' : 'Table';
            const typeClass = entity.type === 'view' ? '#3b82f6' : '#64748b';

            let html = `
                <div class="field-detail">
                    <div class="detail-label">Type</div>
                    <div class="type-tag" style="background: ${typeClass}; color: white;">${typeLabel}</div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Name</div>
                    <div class="detail-value" style="font-weight: 600">${entity.name}</div>
                </div>
                <div class="field-detail">
                    <div class="detail-label">Description</div>
                    <div class="detail-value">${entity.description || "No description available."}</div>
                </div>
            `;

            // Show view definition if this is a view
            if (entity.type === 'view' && entity.definition) {
                html += `
                    <div class="field-detail">
                        <div class="detail-label">View Definition</div>
                        <div class="detail-value" style="font-family: monospace; font-size: 11px; background: #f8fafc; padding: 8px; border-radius: 4px;">${entity.definition}</div>
                    </div>
                `;
            }

            content.innerHTML = html;

            sidebar.classList.add('open');
            // Remove row highlights
            document.querySelectorAll('.table-row').forEach(r => r.style.background = '');
        }

        function closeSidebar() {
             document.getElementById('sidebar').classList.remove('open');
             document.querySelectorAll('.table-row').forEach(r => r.style.background = '');
        }
        
        // Close sidebar when clicking on paper blank area
        paper.on('blank:pointerdown', () => {
            closeSidebar();
        });

    </script>
</body>
</html>